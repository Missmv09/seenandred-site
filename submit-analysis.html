<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Submit Your Messages - Seen and Red</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary-red: #dc2626; --dark-red: #991b1b; --light-red: #fee2e2;
            --dark-gray: #1f2937; --medium-gray: #6b7280; --light-gray: #f9fafb; --white: #ffffff;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6; color: var(--dark-gray); background: var(--light-gray); min-height: 100vh;
        }
        .container { max-width: 600px; margin: 0 auto; padding: 2rem 20px; }
        .header { text-align: center; margin-bottom: 2rem; }
        .header h1 { font-size: 2.5rem; color: var(--dark-gray); margin-bottom: 0.5rem; }
        .header p { font-size: 1.1rem; color: var(--medium-gray); }
        
        .tier-cards { display: grid; gap: 1.5rem; margin-bottom: 2rem; }
        .tier-card {
            background: var(--white); border-radius: 16px; padding: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); position: relative; overflow: hidden;
            transition: all 0.3s ease; border: 2px solid transparent;
        }
        .tier-card:hover { transform: translateY(-4px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); border-color: var(--primary-red); }
        .tier-card.purchased { border-color: #10b981; background: linear-gradient(135deg, #ecfdf5 0%, var(--white) 100%); }
        
        .tier-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .tier-title { font-size: 1.3rem; font-weight: bold; color: var(--dark-gray); }
        .tier-price { font-size: 1.1rem; color: var(--primary-red); font-weight: 600; }
        .tier-description { color: var(--medium-gray); margin-bottom: 1rem; line-height: 1.5; }
        .tier-limits { font-size: 0.9rem; color: var(--medium-gray); margin-bottom: 1rem; font-weight: 500; }
        
        .tier-btn {
            width: 100%; padding: 1rem; border: none; border-radius: 8px;
            font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;
        }
        .tier-btn.primary { background: var(--primary-red); color: var(--white); }
        .tier-btn.primary:hover { background: var(--dark-red); }
        .tier-btn.success { background: #10b981; color: var(--white); }
        .tier-btn.success:hover { background: #059669; }
        .tier-btn.secondary { background: #e5e7eb; color: var(--dark-gray); }
        .tier-btn.secondary:hover { background: #d1d5db; }
        .tier-btn:disabled { background: #9ca3af; color: #6b7280; cursor: not-allowed; }
        
        .upgrade-options { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
        .upgrade-btn { flex: 1; padding: 0.5rem; font-size: 0.9rem; }
        
        .purchase-badge {
            position: absolute; top: 1rem; right: 1rem; 
            background: #10b981; color: white; padding: 0.25rem 0.75rem;
            border-radius: 12px; font-size: 0.8rem; font-weight: 600;
        }
        
        @media (max-width: 768px) {
            .container { padding: 1rem 15px; }
            .header h1 { font-size: 2rem; }
            .tier-card { padding: 1.5rem; }
            .upgrade-options { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Your Analysis Portal</h1>
            <p>Choose your tier to access message analysis</p>
        </div>

        <div class="tier-cards">
            <div class="tier-card" id="flag-check-card">
                <div class="purchase-badge" id="flag-check-badge" style="display: none;">Purchased</div>
                <div class="tier-header">
                    <div class="tier-title">Flag Check</div>
                    <div class="tier-price">$9</div>
                </div>
                <div class="tier-description">3 message analyses with red & green flag identification</div>
                <div class="tier-limits" id="flag-check-limits">3 analyses included</div>
                <button class="tier-btn primary" id="flag-check-btn">Purchase Flag Check ($9)</button>
                <div class="upgrade-options" id="flag-check-upgrade" style="display: none;">
                    <button class="tier-btn secondary upgrade-btn" onclick="buyMore('flag_check')">Buy 3 More ($9)</button>
                    <button class="tier-btn secondary upgrade-btn" onclick="upgrade('pattern_check')">Upgrade to Pattern Check</button>
                </div>
            </div>

            <div class="tier-card" id="pattern-check-card">
                <div class="purchase-badge" id="pattern-check-badge" style="display: none;">Purchased</div>
                <div class="tier-header">
                    <div class="tier-title">Pattern Check</div>
                    <div class="tier-price">$19</div>
                </div>
                <div class="tier-description">6 message analyses with deep pattern recognition & trauma insights</div>
                <div class="tier-limits" id="pattern-check-limits">6 analyses included</div>
                <button class="tier-btn primary" id="pattern-check-btn">Purchase Pattern Check ($19)</button>
                <div class="upgrade-options" id="pattern-check-upgrade" style="display: none;">
                    <button class="tier-btn secondary upgrade-btn" onclick="buyMore('pattern_check')">Buy 6 More ($19)</button>
                    <button class="tier-btn secondary upgrade-btn" onclick="upgrade('reality_check')">Upgrade to Reality Check</button>
                </div>
            </div>

            <div class="tier-card" id="reality-check-card">
                <div class="purchase-badge" id="reality-check-badge" style="display: none;">Purchased</div>
                <div class="tier-header">
                    <div class="tier-title">Reality Check</div>
                    <div class="tier-price">$29/mo</div>
                </div>
                <div class="tier-description">Unlimited analyses with 24/7 access & voice message support</div>
                <div class="tier-limits" id="reality-check-limits">Unlimited monthly analyses</div>
                <button class="tier-btn primary" id="reality-check-btn">Purchase Reality Check ($29/mo)</button>
                <div class="upgrade-options" id="reality-check-upgrade" style="display: none;">
                    <button class="tier-btn secondary upgrade-btn" onclick="buyMore('reality_check')">Renew Subscription ($29)</button>
                </div>
            </div>
        </div>

        <div style="text-align: center; margin-top: 2rem;">
            <p style="color: var(--medium-gray); font-size: 0.9rem;">
                Need help? <a href="index.html" style="color: var(--primary-red);">‚Üê Back to homepage</a>
            </p>
        </div>
    </div>

    <script>
        // Tier configuration
        const TIERS = {
            flag_check: {
                name: 'Flag Check',
                price: 9,
                limit: 3,
                stripeUrl: 'https://buy.stripe.com/28E00i2RnfSC546gtr9EI0b',
                tallyUrl: 'https://tally.so/r/mJbgaz'
            },
            pattern_check: {
                name: 'Pattern Check', 
                price: 19,
                limit: 6,
                stripeUrl: 'https://buy.stripe.com/28E3cueA58qa4023GF9EI0a',
                tallyUrl: 'https://tally.so/r/m6E2VJ'
            },
            reality_check: {
                name: 'Reality Check',
                price: 29,
                limit: -1,
                stripeUrl: 'https://buy.stripe.com/3cI3cu1NjeOy68a6SR9EI03',
                tallyUrl: 'https://tally.so/r/waqYzb'
            }
        };

        let userData = {
            email: null,
            purchases: {}
        };

        function init() {
            console.log('Page initialized');
            
            const params = new URLSearchParams(window.location.search);
            const tier = params.get('tier');
            const submitted = params.get('submitted') === 'true';
            let email = params.get('email') || params.get('customer_email');
            
            console.log('URL params:', { tier, submitted, email });

            // Get email if not provided
            if (!email || email === '{CHECKOUT_SESSION_CUSTOMER_EMAIL}') {
                email = prompt('Please enter your email to access your analysis:');
                if (!email || !email.includes('@')) {
                    alert('Valid email required');
                    window.location.href = 'index.html';
                    return;
                }
            }

            userData.email = email;
            loadUserData();

            // Handle new purchase
            if (submitted && tier && TIERS[tier]) {
                console.log('Processing new purchase:', tier);
                addPurchase(tier);
            }

            updateDisplay();
        }

        function loadUserData() {
            const saved = localStorage.getItem(`user_${userData.email}`);
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    userData.purchases = parsed.purchases || {};
                    console.log('Loaded user data:', userData.purchases);
                } catch (e) {
                    console.log('Error loading user data:', e);
                    userData.purchases = {};
                }
            }
        }

        function saveUserData() {
            localStorage.setItem(`user_${userData.email}`, JSON.stringify({
                purchases: userData.purchases
            }));
            console.log('Saved user data:', userData.purchases);
        }

        function addPurchase(tier) {
    const config = TIERS[tier];
    
    // Get a unique session ID from URL or create one
    const urlParams = new URLSearchParams(window.location.search);
    const sessionId = urlParams.get('session_id') || urlParams.get('checkout_session_id') || `manual_${Date.now()}_${Math.random()}`;
    
    console.log('Processing purchase with session ID:', sessionId);
    
    // Check if this session was already processed
    const processedSessions = JSON.parse(localStorage.getItem('processed_sessions') || '[]');
    if (processedSessions.includes(sessionId)) {
        console.log('Session already processed, skipping');
        return;
    }
    
    // Initialize if doesn't exist
    if (!userData.purchases[tier]) {
        userData.purchases[tier] = { count: 0, used: 0, lastPurchase: 0 };
    }

    // Add analyses
    userData.purchases[tier].count += config.limit === -1 ? 1 : config.limit;
    userData.purchases[tier].lastPurchase = Date.now();
    
    // Mark this session as processed
    processedSessions.push(sessionId);
    localStorage.setItem('processed_sessions', JSON.stringify(processedSessions));
    
    console.log(`Added ${config.limit} analyses to ${tier} for session ${sessionId}`);
    saveUserData();
}

        function updateDisplay() {
            Object.keys(TIERS).forEach(tier => {
                const config = TIERS[tier];
                const purchase = userData.purchases[tier];
                
                const card = document.getElementById(`${tier.replace('_', '-')}-card`);
                const btn = document.getElementById(`${tier.replace('_', '-')}-btn`);
                const limits = document.getElementById(`${tier.replace('_', '-')}-limits`);
                const badge = document.getElementById(`${tier.replace('_', '-')}-badge`);
                const upgrade = document.getElementById(`${tier.replace('_', '-')}-upgrade`);

                if (purchase && purchase.count > 0) {
                    // User has purchased this tier
                    card.classList.add('purchased');
                    badge.style.display = 'block';

                    if (config.limit === -1) {
                        // Unlimited tier
                        limits.textContent = 'Unlimited analyses available';
                        btn.textContent = `Access ${config.name} Analysis`;
                        btn.className = 'tier-btn success';
                        btn.onclick = () => accessAnalysis(tier);
                    } else {
                        // Limited tier
                        const remaining = purchase.count - purchase.used;
                        limits.textContent = `${purchase.used}/${purchase.count} analyses used (${remaining} remaining)`;
                        
                        if (remaining > 0) {
                            btn.textContent = `Access ${config.name} Analysis (${remaining} left)`;
                            btn.className = 'tier-btn success';
                            btn.onclick = () => accessAnalysis(tier);
                        } else {
                            btn.textContent = 'All Analyses Used - Buy More';
                            btn.className = 'tier-btn secondary';
                            btn.onclick = () => buyMore(tier);
                            upgrade.style.display = 'flex';
                        }
                    }
                } else {
                    // User hasn't purchased this tier
                    limits.textContent = `${config.limit === -1 ? 'Unlimited' : config.limit} analyses included`;
                    btn.textContent = `Purchase ${config.name} ($${config.price}${config.limit === -1 ? '/mo' : ''})`;
                    btn.className = 'tier-btn primary';
                    btn.onclick = () => purchase(tier);
                }
            });
        }

        function purchase(tier) {
            console.log('Purchasing tier:', tier);
            window.location.href = TIERS[tier].stripeUrl;
        }

        function accessAnalysis(tier) {
            console.log('Accessing analysis for tier:', tier);
            const config = TIERS[tier];
            const purchase = userData.purchases[tier];

            // For limited tiers, decrement usage
            if (config.limit !== -1) {
                const remaining = purchase.count - purchase.used;
                if (remaining <= 0) {
                    alert('No analyses remaining. Please purchase more.');
                    return;
                }
                
                userData.purchases[tier].used++;
                saveUserData();
                updateDisplay();
            }

            // Redirect to Tally form
            window.location.href = config.tallyUrl;
        }

        function buyMore(tier) {
            console.log('Buying more of tier:', tier);
            window.location.href = TIERS[tier].stripeUrl;
        }

        function upgrade(tier) {
            console.log('Upgrading to tier:', tier);
            window.location.href = TIERS[tier].stripeUrl;
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
