<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Analysis Portal - Seen and Red</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary-red: #dc2626; --dark-red: #991b1b; --light-red: #fee2e2;
            --dark-gray: #1f2937; --medium-gray: #6b7280; --light-gray: #f9fafb; --white: #ffffff;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6; color: var(--dark-gray); background: var(--light-gray); min-height: 100vh;
        }
        .container { max-width: 600px; margin: 0 auto; padding: 2rem 20px; }
        .header { text-align: center; margin-bottom: 2rem; }
        .header h1 { font-size: 2.5rem; color: var(--dark-gray); margin-bottom: 0.5rem; }
        .header p { font-size: 1.1rem; color: var(--medium-gray); }
        
        .tier-cards { display: grid; gap: 1.5rem; margin-bottom: 2rem; }
        .tier-card {
            background: var(--white); border-radius: 16px; padding: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); position: relative; overflow: hidden;
            transition: all 0.3s ease; border: 2px solid transparent;
        }
        .tier-card:hover { transform: translateY(-4px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); border-color: var(--primary-red); }
        .tier-card.active { border-color: #10b981; background: linear-gradient(135deg, #ecfdf5 0%, var(--white) 100%); }
        
        .tier-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .tier-title { font-size: 1.3rem; font-weight: bold; color: var(--dark-gray); }
        .tier-price { font-size: 1.1rem; color: var(--primary-red); font-weight: 600; }
        .tier-description { color: var(--medium-gray); margin-bottom: 1rem; line-height: 1.5; }
        .tier-limits { font-size: 0.9rem; color: var(--medium-gray); margin-bottom: 1rem; font-weight: 500; }
        
        .tier-btn {
            width: 100%; padding: 1rem; border: none; border-radius: 8px;
            font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;
        }
        .tier-btn.primary { background: var(--primary-red); color: var(--white); }
        .tier-btn.primary:hover { background: var(--dark-red); }
        .tier-btn.success { background: #10b981; color: var(--white); }
        .tier-btn.success:hover { background: #059669; }
        .tier-btn.expired { background: #f59e0b; color: var(--white); }
        .tier-btn.expired:hover { background: #d97706; }
        
        .active-badge {
            position: absolute; top: 1rem; right: 1rem; 
            background: #10b981; color: white; padding: 0.25rem 0.75rem;
            border-radius: 12px; font-size: 0.8rem; font-weight: 600;
        }
        
        .expires-info {
            background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px;
            padding: 0.75rem; margin-top: 1rem; font-size: 0.9rem;
        }
        
        @media (max-width: 768px) {
            .container { padding: 1rem 15px; }
            .header h1 { font-size: 2rem; }
            .tier-card { padding: 1.5rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Your Analysis Portal</h1>
            <p>Access unlimited AI-powered message analysis</p>
        </div>

        <div class="tier-cards">
            <div class="tier-card" id="basic-card">
                <div class="active-badge" id="basic-badge" style="display: none;">Active</div>
                <div class="tier-header">
                    <div class="tier-title">Basic Analysis</div>
                    <div class="tier-price">$9/month</div>
                </div>
                <div class="tier-description">Unlimited basic flag detection and pattern recognition</div>
                <div class="tier-limits" id="basic-limits">Unlimited monthly analyses</div>
                <button class="tier-btn primary" id="basic-btn">Subscribe to Basic ($9/mo)</button>
                <div class="expires-info" id="basic-expires" style="display: none;">
                    <strong>Expires:</strong> <span id="basic-expire-date"></span>
                </div>
            </div>

            <div class="tier-card" id="advanced-card">
                <div class="active-badge" id="advanced-badge" style="display: none;">Active</div>
                <div class="tier-header">
                    <div class="tier-title">Advanced Analysis</div>
                    <div class="tier-price">$19/month</div>
                </div>
                <div class="tier-description">Unlimited deep pattern recognition, trauma insights & communication analysis</div>
                <div class="tier-limits" id="advanced-limits">Unlimited monthly analyses</div>
                <button class="tier-btn primary" id="advanced-btn">Subscribe to Advanced ($19/mo)</button>
                <div class="expires-info" id="advanced-expires" style="display: none;">
                    <strong>Expires:</strong> <span id="advanced-expire-date"></span>
                </div>
            </div>

            <div class="tier-card" id="premium-card">
                <div class="active-badge" id="premium-badge" style="display: none;">Active</div>
                <div class="tier-header">
                    <div class="tier-title">Premium Analysis</div>
                    <div class="tier-price">$29/month</div>
                </div>
                <div class="tier-description">Unlimited comprehensive analysis with voice messages, priority support & advanced insights</div>
                <div class="tier-limits" id="premium-limits">Unlimited monthly analyses + priority support</div>
                <button class="tier-btn primary" id="premium-btn">Subscribe to Premium ($29/mo)</button>
                <div class="expires-info" id="premium-expires" style="display: none;">
                    <strong>Expires:</strong> <span id="premium-expire-date"></span>
                </div>
            </div>
        </div>

        <div style="text-align: center; margin-top: 2rem;">
            <p style="color: var(--medium-gray); font-size: 0.9rem;">
                Questions? <a href="index.html" style="color: var(--primary-red);">‚Üê Back to homepage</a>
            </p>
        </div>
    </div>

    <script>
        // Subscription tier configuration
        const TIERS = {
            basic: {
                name: 'Basic Analysis',
                price: 9,
                stripeUrl: 'https://buy.stripe.com/28E00i2RnfSC546gtr9EI0b',
                tallyUrl: 'https://tally.so/r/mJbgaz'
            },
            advanced: {
                name: 'Advanced Analysis', 
                price: 19,
                stripeUrl: 'https://buy.stripe.com/28E3cueA58qa4023GF9EI0a',
                tallyUrl: 'https://tally.so/r/m6E2VJ'
            },
            premium: {
                name: 'Premium Analysis',
                price: 29,
                stripeUrl: 'https://buy.stripe.com/3cI3cu1NjeOy68a6SR9EI03',
                tallyUrl: 'https://tally.so/r/waqYzb'
            }
        };

        let userData = {
            email: null,
            subscriptions: {}
        };

        function init() {
            const params = new URLSearchParams(window.location.search);
            const tier = params.get('tier');
            const submitted = params.get('submitted') === 'true';
            let email = params.get('email') || params.get('customer_email');
            
            // Get email if not provided
            if (!email || email === '{CHECKOUT_SESSION_CUSTOMER_EMAIL}') {
                if (submitted && tier) {
                    email = prompt('Please enter your email to activate your subscription:');
                } else {
                    email = prompt('Please enter your email to check your subscriptions:');
                }
                if (!email || !email.includes('@')) {
                    alert('Valid email required');
                    window.location.href = 'index.html';
                    return;
                }
            }

            userData.email = email;
            loadUserData();

            // Handle new subscription activation
            if (submitted && tier && TIERS[tier]) {
                activateSubscription(tier);
            }

            updateDisplay();
        }

        function loadUserData() {
            const saved = localStorage.getItem(`subs_${userData.email}`);
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    userData.subscriptions = parsed.subscriptions || {};
                } catch (e) {
                    userData.subscriptions = {};
                }
            }
        }

        function saveUserData() {
            localStorage.setItem(`subs_${userData.email}`, JSON.stringify({
                subscriptions: userData.subscriptions
            }));
        }

        function activateSubscription(tier) {
            const now = new Date();
            const expiryDate = new Date(now.getTime() + (30 * 24 * 60 * 60 * 1000)); // 30 days from now
            
            userData.subscriptions[tier] = {
                active: true,
                startDate: now.toISOString(),
                expiryDate: expiryDate.toISOString(),
                lastActivated: now.toISOString()
            };
            
            saveUserData();
            
            // Clean URL after processing
            const cleanUrl = `${window.location.pathname}?email=${encodeURIComponent(userData.email)}`;
            window.history.replaceState({}, '', cleanUrl);
        }

        function updateDisplay() {
            Object.keys(TIERS).forEach(tier => {
                const config = TIERS[tier];
                const subscription = userData.subscriptions[tier];
                
                const card = document.getElementById(`${tier}-card`);
                const btn = document.getElementById(`${tier}-btn`);
                const limits = document.getElementById(`${tier}-limits`);
                const badge = document.getElementById(`${tier}-badge`);
                const expires = document.getElementById(`${tier}-expires`);
                const expireDate = document.getElementById(`${tier}-expire-date`);

                if (subscription && subscription.active) {
                    const expiryDate = new Date(subscription.expiryDate);
                    const now = new Date();
                    
                    if (expiryDate > now) {
                        // Active subscription
                        card.classList.add('active');
                        badge.style.display = 'block';
                        limits.textContent = 'Unlimited analyses until ' + expiryDate.toLocaleDateString();
                        btn.textContent = `Access ${config.name}`;
                        btn.className = 'tier-btn success';
                        btn.onclick = () => accessAnalysis(tier);
                        
                        expires.style.display = 'block';
                        expireDate.textContent = expiryDate.toLocaleDateString();
                    } else {
                        // Expired subscription
                        card.classList.remove('active');
                        badge.style.display = 'none';
                        limits.textContent = 'Subscription expired';
                        btn.textContent = `Renew ${config.name} ($${config.price}/mo)`;
                        btn.className = 'tier-btn expired';
                        btn.onclick = () => subscribe(tier);
                        
                        expires.style.display = 'none';
                    }
                } else {
                    // No subscription
                    limits.textContent = 'Unlimited monthly analyses';
                    btn.textContent = `Subscribe to ${config.name} ($${config.price}/mo)`;
                    btn.className = 'tier-btn primary';
                    btn.onclick = () => subscribe(tier);
                    
                    expires.style.display = 'none';
                }
            });
        }

        function subscribe(tier) {
            window.location.href = TIERS[tier].stripeUrl;
        }

        function accessAnalysis(tier) {
            const subscription = userData.subscriptions[tier];
            if (!subscription || !subscription.active) {
                alert('No active subscription. Please subscribe first.');
                return;
            }
            
            const expiryDate = new Date(subscription.expiryDate);
            if (new Date() > expiryDate) {
                alert('Your subscription has expired. Please renew to continue.');
                updateDisplay();
                return;
            }

            // Redirect to Tally form
            window.location.href = TIERS[tier].tallyUrl;
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
